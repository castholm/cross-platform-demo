<!DOCTYPE html>

<meta charset=utf-8>
<link rel=icon href=data:,>
<title>app</title>

<script type=module>
const canvas = document.getElementById("canvas")
const stderr = document.getElementById("stderr")

const gl = canvas.getContext("webgl2")
const glObjects = new Map()
let glObjectId = 0

const utf8Decoder = new TextDecoder()
const utf8Encoder = new TextEncoder()
const sb = []

function derefU8(ptr, len) {
  return new Uint8Array(exports.memory.buffer, ptr, len)
}
function derefI32(ptr, len) {
  return new Int32Array(exports.memory.buffer, ptr, len)
}
function derefF32(ptr, len) {
  return new Float32Array(exports.memory.buffer, ptr, len)
}
const { instance: { exports } } = await WebAssembly.instantiateStreaming(fetch("lib/app.wasm"), {
  debug: {
    writeToStderr(ptr, len) {
      const string = utf8Decoder.decode(derefU8(ptr, len))
      stderr.textContent += string
    },
  },
  gl: {
    attachShader(program, shader) {
      gl.attachShader(glObjects.get(program), glObjects.get(shader))
    },
    clearBufferfv(buffer, drawbuffer, value) {
      gl.clearBufferfv(buffer, drawbuffer, derefF32(value, 4)) // TODO: support other value array lengths
    },
    compileShader(shader) {
      gl.compileShader(glObjects.get(shader))
    },
    createProgram() {
      const programObject = gl.createProgram()
      if (!programObject) return 0
      glObjects.set(++glObjectId, programObject)
      return glObjectId
    },
    createShader(type) {
      const shaderObject = gl.createShader(type)
      if (!shaderObject) return 0
      glObjects.set(++glObjectId, shaderObject)
      return glObjectId
    },
    deleteProgram(program) {
      gl.deleteProgram(glObjects.get(program) ?? null)
      glObjects.delete(program)
    },
    deleteShader(shader) {
      gl.deleteShader(glObjects.get(shader) ?? null)
      glObjects.delete(shader)
    },
    disable(cap) {
      gl.disable(cap)
    },
    enable(cap) {
      gl.enable(cap)
    },
    getProgramInfoLogImpl(program, bufSize, infoLog) {
      const programObject = glObjects.get(program)
      if (!programObject) return 0
      return utf8Encoder.encodeInto(gl.getProgramInfoLog(programObject), derefU8(infoLog, bufSize)).written
    },
    getProgramiv(program, pname, params) {
      const programObject = glObjects.get(program)
      if (!programObject) return
      const val = gl.getProgramParameter(programObject, pname)
      if (val === null) return
      derefI32(params, 1)[0] = val
    },
    getShaderInfoLogImpl(shader, bufSize, infoLog) {
      const shaderObject = glObjects.get(shader)
      if (!shaderObject) return 0
      return utf8Encoder.encodeInto(gl.getShaderInfoLog(shaderObject), derefU8(infoLog, bufSize)).written
    },
    getShaderiv(shader, pname, params) {
      const shaderObject = glObjects.get(shader)
      if (!shaderObject) return
      const val = gl.getShaderParameter(shaderObject, pname)
      if (val === null) return
      derefI32(params, 1)[0] = val
    },
    getShaderSourceImpl(shader, bufSize, source) {
      const shaderObject = glObjects.get(shader)
      if (!shaderObject) return 0
      return utf8Encoder.encodeInto(gl.getShaderSource(shaderObject), derefU8(source, bufSize)).written
    },
    linkProgram(program) {
      gl.linkProgram(glObjects.get(program))
    },
    scissor(x, y, width, height) {
      gl.scissor(x, y, width, height)
    },
    shaderSourceImpl(shader, string, length, isLastSegment) {
      sb.push(utf8Decoder.decode(derefU8(string, length)))
      if (isLastSegment) {
        gl.shaderSource(glObjects.get(shader), sb.join(""))
        sb.length = 0
      }
    }
  },
})

exports.start()

window.requestAnimationFrame(draw)
function draw() {
  exports.draw()
  window.requestAnimationFrame(draw)
}
</script>

<canvas id=canvas width=640 height=480 style=display:block></canvas>
<h1>stderr</h1>
<pre id=stderr style=white-space:pre-wrap></pre>
